rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // Check if the user is authenticated and verified via App Check
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the incoming UserProfile data is structurally valid
    function isValidUser(data) {
      return data.size() == 9
      && data.id is string
      && data.firstName is string && data.firstName.size() <= 50
      && data.lastName is string && data.lastName.size() <= 75
      && data.role is string && data.role.size() <= 50
      && data.email is string && data.email.size() <= 100
      && data.location is string && data.location.size() <= 100
      && data.timeZone is string && data.timeZone.size() <= 50
      && data.profileImageUrl is string
      && data.personalBio is string && data.personalBio.size() <= 1000;
    }
    
    // Check if the incoming CompanyProfile data is structurally valid
    function isValidCompany(data) {
      return data.size() == 12
      && data.id is string
      && data.userId is string
      && data.name is string && data.name.size() <= 100
      && data.website is string && data.website.size() <= 100
      && data.hqCountry is string && data.hqCountry.size() <= 50
      && data.hqCity is string && data.hqCity.size() <= 50
      && data.stage is string && data.stage.size() <= 50
      && data.employeeRange is string && data.employeeRange.size() <= 50
      && data.companyBio is string && data.companyBio.size() <= 1000
      && data.industries is list && data.industries.size() <= 10
      && data.challenges is list && data.challenges.size() <= 3
      && data.desiredExpertise is list && data.desiredExpertise.size() <= 10;
    }
    
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();
      
      // CREATE: Must match their Firebase Auth email, match UID as doc ID, and have valid data
      allow create: if isAuthenticated() 
                    && request.resource.data.email == request.auth.token.email
                    && isValidUser(request.resource.data);
      
      // UPDATE: Must already own this document AND keep their own email AND have valid data
      allow update: if isAuthenticated() 
                    && resource.data.email == request.auth.token.email
                    && isValidUser(request.resource.data);
      
      // DELETE
      allow delete: if isAuthenticated() 
                    && resource.data.email == request.auth.token.email;
    }
    
    match /companies/{companyId} {
      // Anyone authenticated can read company profiles
      allow read: if isAuthenticated();
      
      // WRITE: Must own the associated UserProfile document via backend Join and have valid data
      allow write: if isAuthenticated() 
                   && get(/databases/$(database)/documents/users/$(request.resource.data.userId)).data.email == request.auth.token.email
                   && isValidCompany(request.resource.data);
    }
  }
}
